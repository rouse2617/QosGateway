var e=(e,a,l)=>new Promise((t,r)=>{var s=e=>{try{n(l.next(e))}catch(a){r(a)}},o=e=>{try{n(l.throw(e))}catch(a){r(a)}},n=e=>e.done?t(e.value):Promise.resolve(e.value).then(s,o);n((l=l.apply(e,a)).next())});import{d as a,m as l,e as t,a as r}from"./index-JEKLdrSO.js";import{u as s,H as o,i as n,a as u,b as i,c,d,e as v,f}from"./echarts-BY7lpYui.js";import{r as m,c as h,d as y,J as p,z as _,L as g,K as w,T as b,U as x,V as k,W as S,B as D,A as z,x as A,R as j,y as H,u as I,X as L,Q as M,Y as P,Z as C,o as R,I as B,_ as E,$ as V,a0 as G,a1 as W}from"./element-plus-DA67S2ud.js";import{u as T}from"./useToast-hTRWXoI1.js";import{_ as U}from"./_plugin-vue_export-helper-BCo6x5W8.js";const $=a("metrics",()=>{const a=m(null),r=m(null),s=m(!1),o=m(null),n=m(0),u=m(0),{error:i}=T(),c=e=>Date.now()-e<5e3;function d(t=!1){return e(this,null,function*(){if(!t&&c(n.value)&&a.value)return a.value;s.value=!0,o.value=null;try{const{data:e}=yield l.get();return a.value=e,n.value=Date.now(),e}catch(e){throw o.value=e,i(e,"获取指标失败"),e}finally{s.value=!1}})}function v(a=!1){return e(this,null,function*(){if(!a&&c(u.value)&&r.value)return r.value;try{const{data:e}=yield t.getStatus();return r.value=e,u.value=Date.now(),e}catch(e){throw o.value=e,i(e,"获取紧急状态失败"),e}})}const f=h(()=>a.value?(100*a.value.cache_hit_ratio).toFixed(1):"0"),y=h(()=>a.value?a.value.emergency_active?"emergency":"normal"!==a.value.degradation_level?"degraded":"normal":"unknown"),p=h(()=>{var e;return(null==(e=r.value)?void 0:e.active)||!1});return{metrics:a,emergency:r,loading:s,error:o,cacheHitRatioPercent:f,systemStatus:y,isEmergencyActive:p,fetchMetrics:d,fetchEmergency:v,refreshAll:function(){return e(this,null,function*(){yield Promise.all([d(!0),v(!0)])})},reset:function(){a.value=null,r.value=null,o.value=null,n.value=0,u.value=0}}}),q={class:"card-skeleton"},F={key:0,class:"card-skeleton-header"},J={class:"card-skeleton-body"},K=U(y({__name:"CardSkeleton",props:{showHeader:{type:Boolean,default:!0},lines:{default:3}},setup(e){const a=e;return(l,t)=>(_(),p("div",q,[e.showHeader?(_(),p("div",F,[...t[0]||(t[0]=[w("div",{class:"skeleton-title"},[w("div",{class:"skeleton-shimmer"})],-1)])])):g("",!0),w("div",J,[b(l.$slots,"default",{},()=>[(_(!0),p(x,null,k(e.lines,e=>{return _(),p("div",{key:e,class:"skeleton-line",style:S({width:(l=e,l===a.lines?"70%":85+10*Math.random()+"%")})},[...t[1]||(t[1]=[w("div",{class:"skeleton-shimmer"},null,-1)])],4);var l}),128))],!0)])]))}}),[["__scopeId","data-v-7dd956cc"]]),N={class:"error-state"},O={class:"error-state-icon"},Q={class:"error-state-title"},X={key:0,class:"error-state-message"},Y={key:1,class:"error-state-details"},Z={class:"error-state-actions"},ee=U(y({__name:"ErrorState",props:{title:{default:"加载失败"},errorMessage:{default:"抱歉，数据加载失败"},errorDetails:{},showDetails:{type:Boolean,default:!1},showGoHome:{type:Boolean,default:!1}},emits:["retry"],setup(e,{emit:a}){const l=a,t=r();function s(){l("retry")}function o(){t.push("/")}return(a,l)=>{const t=A("el-icon"),r=A("el-collapse-item"),n=A("el-collapse"),u=A("el-button");return _(),p("div",N,[w("div",O,[D(t,{size:60,color:"#f56c6c"},{default:z(()=>[D(I(L))]),_:1})]),w("div",Q,j(e.title),1),e.errorMessage?(_(),p("div",X,j(e.errorMessage),1)):g("",!0),e.showDetails&&e.errorDetails?(_(),p("div",Y,[D(n,null,{default:z(()=>[D(r,{title:"错误详情",name:"details"},{default:z(()=>[w("pre",null,j(e.errorDetails),1)]),_:1})]),_:1})])):g("",!0),w("div",Z,[D(u,{type:"primary",onClick:s},{default:z(()=>[D(t,null,{default:z(()=>[D(I(P))]),_:1}),l[0]||(l[0]=M(" 重试 ",-1))]),_:1}),e.showGoHome?(_(),H(u,{key:0,onClick:o},{default:z(()=>[D(t,null,{default:z(()=>[D(I(C))]),_:1}),l[1]||(l[1]=M(" 返回首页 ",-1))]),_:1})):g("",!0)])])}}}),[["__scopeId","data-v-a418b308"]]),ae={class:"dashboard"},le={class:"card-header"},te={class:"alert-content"},re=U(y({__name:"Dashboard",setup(a){s([n,u,i,c,d,v,f]);const l=r(),t=$(),y=m("1h"),b=h(()=>t.metrics),k=h(()=>t.cacheHitRatioPercent),S=h(()=>t.isEmergencyActive),j=h(()=>{return b.value?b.value.emergency_active?"紧急":{normal:"正常",degraded:"降级",emergency:"紧急"}[e=b.value.degradation_level]||e:"未知";var e}),P=h(()=>{if(!b.value)return"#909399";if(b.value.emergency_active)return"#f56c6c";return{success:"#67c23a",warning:"#e6a23c",danger:"#f56c6c"}[{normal:"success",degraded:"warning",emergency:"danger"}[b.value.degradation_level]||"info"]||"#909399"}),C=h(()=>({tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["请求数","拒绝数"],bottom:0},grid:{left:"3%",right:"4%",bottom:"15%",top:"10%",containLabel:!0},xAxis:{type:"category",data:["00:00","04:00","08:00","12:00","16:00","20:00"],boundaryGap:!1},yAxis:{type:"value",name:"请求数"},series:[{name:"请求数",type:"line",smooth:!0,data:[120,200,150,80,70,110],areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(64, 158, 255, 0.3)"},{offset:1,color:"rgba(64, 158, 255, 0.05)"}]}},itemStyle:{color:"#409eff"}},{name:"拒绝数",type:"line",smooth:!0,data:[5,10,8,3,2,4],itemStyle:{color:"#f56c6c"}}]})),T=h(()=>({tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",left:"left",bottom:0},series:[{name:"令牌层级",type:"pie",radius:["40%","70%"],center:["50%","45%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:!0,formatter:"{b}: {d}%"},emphasis:{label:{show:!0,fontSize:16,fontWeight:"bold"}},data:[{value:60,name:"L3 本地",itemStyle:{color:"#67c23a"}},{value:30,name:"L2 应用",itemStyle:{color:"#409eff"}},{value:10,name:"L1 集群",itemStyle:{color:"#e6a23c"}}]}]}));function U(){return e(this,null,function*(){yield t.refreshAll()})}let q=null;return R(()=>e(this,null,function*(){yield U(),q=window.setInterval(()=>{t.fetchMetrics().catch(console.error)},5e3)})),B(()=>{q&&(clearInterval(q),q=null)}),(e,a)=>{var r;const s=A("el-icon"),n=A("el-statistic"),u=A("el-card"),i=A("el-col"),c=A("el-row"),d=A("el-radio-button"),v=A("el-radio-group"),f=A("el-button"),m=A("el-alert");return _(),p("div",ae,[I(t).loading&&!b.value?(_(),H(K,{key:0,"show-header":!1,lines:4})):I(t).error&&!b.value?(_(),H(ee,{key:1,title:"加载失败","error-message":null==(r=I(t).error)?void 0:r.message,onRetry:U},null,8,["error-message"])):(_(),p(x,{key:2},[D(c,{gutter:20,class:"overview-cards"},{default:z(()=>[D(i,{xs:12,sm:6},{default:z(()=>[D(u,{shadow:"hover",class:"stat-card"},{default:z(()=>{var e;return[D(n,{title:"总请求数",value:(null==(e=b.value)?void 0:e.requests_total)||0,precision:0},{prefix:z(()=>[D(s,{color:"#409eff"},{default:z(()=>[D(I(E))]),_:1})]),_:1},8,["value"])]}),_:1})]),_:1}),D(i,{xs:12,sm:6},{default:z(()=>[D(u,{shadow:"hover",class:"stat-card"},{default:z(()=>{var e;return[D(n,{title:"拒绝请求",value:(null==(e=b.value)?void 0:e.rejected_total)||0,precision:0,"value-style":"color: #f56c6c"},{prefix:z(()=>[D(s,{color:"#f56c6c"},{default:z(()=>[D(I(L))]),_:1})]),_:1},8,["value"])]}),_:1})]),_:1}),D(i,{xs:12,sm:6},{default:z(()=>[D(u,{shadow:"hover",class:"stat-card"},{default:z(()=>[D(n,{title:"缓存命中率",value:Number(k.value),suffix:"%",precision:1},{prefix:z(()=>[D(s,{color:"#67c23a"},{default:z(()=>[D(I(V))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),D(i,{xs:12,sm:6},{default:z(()=>[D(u,{shadow:"hover",class:G(["stat-card",{"emergency-active":S.value}])},{default:z(()=>[D(n,{title:"系统状态",value:j.value},{prefix:z(()=>[D(s,{color:P.value},{default:z(()=>[D(I(W))]),_:1},8,["color"])]),_:1},8,["value"])]),_:1},8,["class"])]),_:1})]),_:1}),D(c,{gutter:20,class:"charts-row"},{default:z(()=>[D(i,{xs:24,lg:16},{default:z(()=>[D(u,{shadow:"hover"},{header:z(()=>[w("div",le,[a[5]||(a[5]=w("span",{class:"card-title"},"请求趋势",-1)),D(v,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=e=>y.value=e),size:"small"},{default:z(()=>[D(d,{label:"1h"},{default:z(()=>[...a[2]||(a[2]=[M("1小时",-1)])]),_:1}),D(d,{label:"6h"},{default:z(()=>[...a[3]||(a[3]=[M("6小时",-1)])]),_:1}),D(d,{label:"24h"},{default:z(()=>[...a[4]||(a[4]=[M("24小时",-1)])]),_:1})]),_:1},8,["modelValue"])])]),default:z(()=>[D(I(o),{option:C.value,style:{height:"320px"},autoresize:""},null,8,["option"])]),_:1})]),_:1}),D(i,{xs:24,lg:8},{default:z(()=>[D(u,{shadow:"hover"},{header:z(()=>[...a[6]||(a[6]=[w("span",{class:"card-title"},"令牌分布",-1)])]),default:z(()=>[D(I(o),{option:T.value,style:{height:"320px"},autoresize:""},null,8,["option"])]),_:1})]),_:1})]),_:1}),S.value?(_(),H(m,{key:0,type:"error",closable:!1,"show-icon":"",class:"emergency-alert"},{title:z(()=>[w("div",te,[a[8]||(a[8]=w("span",null,"紧急模式已激活，部分低优先级请求可能被限制",-1)),D(f,{type:"danger",size:"small",onClick:a[1]||(a[1]=e=>I(l).push("/emergency"))},{default:z(()=>[...a[7]||(a[7]=[M(" 查看详情 ",-1)])]),_:1})])]),_:1})):g("",!0)],64))])}}}),[["__scopeId","data-v-d4ded8c9"]]);export{re as default};
