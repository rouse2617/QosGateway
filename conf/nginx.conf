# OpenResty Rate Limiter Configuration
# 分布式三层令牌桶限流系统

worker_processes auto;
error_log logs/error.log info;
pid logs/nginx.pid;

events {
    worker_connections 10240;
    use epoll;
    multi_accept on;
}

http {
    include mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time cost=$ratelimit_cost remaining=$ratelimit_remaining';

    access_log logs/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Lua 模块路径
    lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/site/lualib/?.lua;$prefix/lua/?.lua;;";
    lua_package_cpath "/usr/local/openresty/lualib/?.so;/usr/local/openresty/site/lualib/?.so;;";

    # 共享内存字典配置
    lua_shared_dict ratelimit_dict 100m;      # 令牌桶缓存
    lua_shared_dict connlimit_dict 10m;       # 连接限制
    lua_shared_dict config_dict 5m;           # 配置缓存
    lua_shared_dict metrics_dict 10m;         # 指标收集
    lua_shared_dict locks_dict 1m;            # 分布式锁

    # 初始化限流系统
    init_by_lua_block {
        -- 预加载模块
        require "ratelimit.cost"
        require "ratelimit.l3_bucket"
        require "ratelimit.connection_limiter"
        require "ratelimit.config_validator"
    }

    init_worker_by_lua_block {
        -- 初始化 Worker
        local init = require "ratelimit.init"
        init.init()
        
        -- 启动降级管理器
        local degradation = require "ratelimit.degradation"
        degradation.start_health_timer()
        
        -- 启动指标上报
        local metrics = require "ratelimit.metrics"
        metrics.start_report_timer()
    }

    # 上游后端服务
    upstream backend {
        server 127.0.0.1:8080;
        keepalive 100;
    }

    # 主服务器
    server {
        listen 80;
        server_name _;

        # 变量定义
        set $ratelimit_cost 0;
        set $ratelimit_remaining 0;

        # 健康检查端点 (跳过限流)
        location /health {
            access_log off;
            content_by_lua_block {
                local cjson = require "cjson.safe"
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode({
                    status = "healthy",
                    timestamp = ngx.now()
                }))
            }
        }

        # Prometheus 指标端点
        location /metrics {
            access_log off;
            content_by_lua_block {
                local metrics = require "ratelimit.metrics"
                metrics.serve_prometheus()
            }
        }

        # 管理 API
        location /admin/ {
            content_by_lua_block {
                local config_api = require "ratelimit.config_api"
                config_api.handle_request()
            }
        }

        # 主要业务路由 (带限流)
        location / {
            # 限流检查
            access_by_lua_block {
                local init = require "ratelimit.init"
                local app_id = ngx.var.http_x_app_id or "default"
                local cluster_id = ngx.var.http_x_cluster_id or "default"
                
                local ok, err = init.check(app_id, cluster_id)
                if not ok then
                    ngx.status = 429
                    ngx.header["Content-Type"] = "application/json"
                    ngx.header["Retry-After"] = err.retry_after or 1
                    ngx.say(require("cjson.safe").encode({
                        error = "rate_limit_exceeded",
                        reason = err.code,
                        retry_after = err.retry_after or 1,
                        remaining = err.remaining or 0,
                        cost = err.cost or 0
                    }))
                    return ngx.exit(429)
                end
            }

            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # 消耗上报
            log_by_lua_block {
                local init = require "ratelimit.init"
                init.log()
            }
        }
    }
}
