# OpenResty Rate Limiter Configuration
# 分布式三层令牌桶限流系统 - 生产环境配置
# Requirements: 8.3, 8.4

#===============================================================================
# 全局配置
#===============================================================================

# Worker 进程数：auto 表示自动检测 CPU 核心数
worker_processes auto;

# Worker 进程 CPU 亲和性绑定（可选，提高性能）
# worker_cpu_affinity auto;

# 错误日志配置
error_log logs/error.log warn;

# PID 文件
pid logs/nginx.pid;

# Worker 进程打开文件数限制
worker_rlimit_nofile 65535;

#===============================================================================
# 事件模块配置
#===============================================================================
events {
    # 每个 Worker 最大连接数
    worker_connections 10240;
    
    # 使用 epoll 事件模型（Linux）
    use epoll;
    
    # 允许一次接受多个连接
    multi_accept on;
    
    # 接受互斥锁（高并发时建议关闭）
    accept_mutex off;
}

#===============================================================================
# HTTP 模块配置
#===============================================================================
http {
    # 基础配置
    include mime.types;
    default_type application/octet-stream;

    #---------------------------------------------------------------------------
    # 日志格式配置
    #---------------------------------------------------------------------------
    
    # 主日志格式（包含限流信息）
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct=$upstream_connect_time '
                    'uht=$upstream_header_time urt=$upstream_response_time '
                    'cost=$ratelimit_cost remaining=$ratelimit_remaining '
                    'app=$http_x_app_id cluster=$http_x_cluster_id';

    # JSON 格式日志（便于日志分析）
    log_format json_log escape=json '{'
                    '"time":"$time_iso8601",'
                    '"remote_addr":"$remote_addr",'
                    '"request":"$request",'
                    '"status":$status,'
                    '"body_bytes_sent":$body_bytes_sent,'
                    '"request_time":$request_time,'
                    '"upstream_response_time":"$upstream_response_time",'
                    '"http_referer":"$http_referer",'
                    '"http_user_agent":"$http_user_agent",'
                    '"http_x_forwarded_for":"$http_x_forwarded_for",'
                    '"ratelimit_cost":"$ratelimit_cost",'
                    '"ratelimit_remaining":"$ratelimit_remaining",'
                    '"app_id":"$http_x_app_id",'
                    '"cluster_id":"$http_x_cluster_id"'
                    '}';

    # 访问日志
    access_log logs/access.log main;
    # access_log logs/access.json.log json_log;  # 可选：JSON 格式日志

    #---------------------------------------------------------------------------
    # 性能优化配置
    #---------------------------------------------------------------------------
    
    # 启用 sendfile
    sendfile on;
    
    # 启用 TCP_NOPUSH
    tcp_nopush on;
    
    # 启用 TCP_NODELAY
    tcp_nodelay on;
    
    # Keepalive 超时
    keepalive_timeout 65;
    
    # 客户端请求体大小限制
    client_max_body_size 100m;
    
    # 客户端请求体缓冲区大小
    client_body_buffer_size 128k;
    
    # 客户端请求头缓冲区大小
    client_header_buffer_size 4k;
    large_client_header_buffers 4 32k;
    
    # 客户端请求超时
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # 发送超时
    send_timeout 60s;
    
    # 重置超时连接
    reset_timedout_connection on;

    # Gzip 压缩
    gzip on;
    gzip_min_length 1024;
    gzip_comp_level 5;
    gzip_types text/plain text/css application/json application/javascript 
               text/xml application/xml application/xml+rss text/javascript;
    gzip_vary on;

    #---------------------------------------------------------------------------
    # Lua 模块路径配置 (Requirements: 8.4)
    #---------------------------------------------------------------------------
    
    # Lua 模块搜索路径
    lua_package_path "/usr/local/openresty/lualib/?.lua;/usr/local/openresty/site/lualib/?.lua;$prefix/lua/?.lua;$prefix/lua/ratelimit/?.lua;;";
    lua_package_cpath "/usr/local/openresty/lualib/?.so;/usr/local/openresty/site/lualib/?.so;;";

    # Lua 代码缓存（生产环境必须开启）
    lua_code_cache on;

    #---------------------------------------------------------------------------
    # 共享内存字典配置 (Requirements: 8.3)
    #---------------------------------------------------------------------------
    
    # 令牌桶缓存 - 100MB
    # 存储 L3 本地令牌、待同步消耗、预留管理等
    lua_shared_dict ratelimit_dict 100m;
    
    # 连接限制 - 10MB
    # 存储 per-app 和 per-cluster 连接计数、连接追踪
    lua_shared_dict connlimit_dict 10m;
    
    # 配置缓存 - 5MB
    # 存储应用配置、集群配置的本地缓存
    lua_shared_dict config_dict 5m;
    
    # 指标收集 - 10MB
    # 存储 Prometheus 指标数据
    lua_shared_dict metrics_dict 10m;
    
    # 分布式锁 - 1MB
    # 用于定时器任务的分布式锁
    lua_shared_dict locks_dict 1m;

    #---------------------------------------------------------------------------
    # Lua 初始化配置 (Requirements: 8.4)
    #---------------------------------------------------------------------------
    
    # Master 进程初始化（预加载模块）
    init_by_lua_block {
        -- 预加载核心模块，减少 Worker 启动时间
        require "cjson.safe"
        require "ratelimit.cost"
        require "ratelimit.l3_bucket"
        require "ratelimit.l2_bucket"
        require "ratelimit.l1_cluster"
        require "ratelimit.borrow"
        require "ratelimit.emergency"
        require "ratelimit.reconciler"
        require "ratelimit.connection_limiter"
        require "ratelimit.reservation"
        require "ratelimit.config_validator"
        require "ratelimit.degradation"
        require "ratelimit.metrics"
        require "ratelimit.redis"
        require "ratelimit.config_api"
        require "ratelimit.init"
        
        ngx.log(ngx.NOTICE, "[ratelimit] Modules preloaded in master process")
    }

    # Worker 进程初始化
    init_worker_by_lua_block {
        -- 初始化限流系统
        local init = require "ratelimit.init"
        local ok, err = init.init()
        if not ok then
            ngx.log(ngx.ERR, "[ratelimit] Failed to initialize: ", err)
        end
        
        -- 启动降级管理器健康检查定时器
        local degradation = require "ratelimit.degradation"
        degradation.start_health_timer()
        
        -- 启动指标上报定时器
        local metrics = require "ratelimit.metrics"
        metrics.start_report_timer()
        
        ngx.log(ngx.NOTICE, "[ratelimit] Worker ", ngx.worker.id(), " initialized")
    }

    #---------------------------------------------------------------------------
    # 上游后端服务配置
    #---------------------------------------------------------------------------
    
    upstream backend {
        # 后端服务器列表
        server 127.0.0.1:8080 weight=1 max_fails=3 fail_timeout=30s;
        # server 127.0.0.1:8081 weight=1 max_fails=3 fail_timeout=30s backup;
        
        # 连接池配置
        keepalive 100;
        keepalive_timeout 60s;
        keepalive_requests 1000;
    }

    # 管理后端服务（Go Admin Backend）
    upstream admin_backend {
        server 127.0.0.1:9090;
        keepalive 10;
    }

    #---------------------------------------------------------------------------
    # 主服务器配置
    #---------------------------------------------------------------------------
    server {
        listen 80;
        listen [::]:80;
        server_name _;

        # 变量定义（用于日志）
        set $ratelimit_cost 0;
        set $ratelimit_remaining 0;

        #-----------------------------------------------------------------------
        # 健康检查端点 (Requirements: 8.7)
        # 跳过限流检查，用于负载均衡器健康检查
        #-----------------------------------------------------------------------
        location = /health {
            access_log off;
            
            content_by_lua_block {
                local cjson = require "cjson.safe"
                local shared = ngx.shared.ratelimit_dict
                local config_dict = ngx.shared.config_dict
                
                local health = {
                    status = "healthy",
                    timestamp = ngx.now(),
                    worker_id = ngx.worker.id(),
                    version = "1.0.0",
                    components = {
                        ratelimit_dict = shared and "ok" or "missing",
                        config_dict = config_dict and "ok" or "missing",
                        connlimit_dict = ngx.shared.connlimit_dict and "ok" or "missing"
                    }
                }
                
                -- 检查降级状态
                local degradation = require "ratelimit.degradation"
                local level = degradation.get_level()
                health.degradation_level = level
                
                if level == "fail_open" then
                    health.status = "degraded"
                end
                
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode(health))
            }
        }

        #-----------------------------------------------------------------------
        # Prometheus 指标端点 (Requirements: 8.8)
        # 暴露 Prometheus 兼容格式的监控指标
        #-----------------------------------------------------------------------
        location = /metrics {
            access_log off;
            
            content_by_lua_block {
                local metrics = require "ratelimit.metrics"
                metrics.serve_prometheus()
            }
        }

        #-----------------------------------------------------------------------
        # 管理 API 路由 (Requirements: 10.1-10.8)
        # 提供配置管理、紧急模式控制、指标查询等 API
        #-----------------------------------------------------------------------
        location /admin/ {
            # 限制管理 API 访问（可配置 IP 白名单）
            # allow 10.0.0.0/8;
            # allow 172.16.0.0/12;
            # allow 192.168.0.0/16;
            # deny all;
            
            content_by_lua_block {
                local config_api = require "ratelimit.config_api"
                config_api.handle_request()
            }
        }

        #-----------------------------------------------------------------------
        # 管理后端代理（可选：代理到 Go Admin Backend）
        #-----------------------------------------------------------------------
        location /api/v1/ {
            # 代理到 Go Admin Backend
            proxy_pass http://admin_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";
            
            # 超时配置
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        #-----------------------------------------------------------------------
        # WebSocket 支持（用于实时指标推送）
        #-----------------------------------------------------------------------
        location /ws/ {
            proxy_pass http://admin_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # WebSocket 超时
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        #-----------------------------------------------------------------------
        # 主要业务路由（带限流）(Requirements: 8.1, 8.2)
        #-----------------------------------------------------------------------
        location / {
            #-------------------------------------------------------------------
            # 限流检查 (access_by_lua_block) - Requirements: 8.1
            #-------------------------------------------------------------------
            access_by_lua_block {
                local init = require "ratelimit.init"
                
                -- 从请求头获取应用和集群标识
                local app_id = ngx.var.http_x_app_id or ngx.var.arg_app_id or "default"
                local cluster_id = ngx.var.http_x_cluster_id or ngx.var.arg_cluster_id or "default"
                local user_id = ngx.var.http_x_user_id or ngx.var.arg_user_id
                
                -- 执行限流检查
                local ok, err = init.check(app_id, user_id, cluster_id)
                
                if not ok then
                    -- 限流拒绝已在 check 函数中处理
                    return
                end
                
                -- 设置日志变量
                local ctx = ngx.ctx.ratelimit
                if ctx then
                    ngx.var.ratelimit_cost = ctx.cost or 0
                    ngx.var.ratelimit_remaining = ctx.remaining or 0
                end
            }

            #-------------------------------------------------------------------
            # 代理到后端服务
            #-------------------------------------------------------------------
            proxy_pass http://backend;
            proxy_http_version 1.1;
            
            # 请求头设置
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";
            
            # 超时配置
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 缓冲配置
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 32k;
            proxy_busy_buffers_size 64k;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;

            #-------------------------------------------------------------------
            # 消耗上报 (log_by_lua_block) - Requirements: 8.2
            #-------------------------------------------------------------------
            log_by_lua_block {
                local init = require "ratelimit.init"
                init.log()
            }
        }

        #-----------------------------------------------------------------------
        # 静态文件服务（可选：管理前端）
        #-----------------------------------------------------------------------
        location /console/ {
            alias /usr/local/openresty/nginx/html/admin-frontend/;
            index index.html;
            try_files $uri $uri/ /console/index.html;
            
            # 缓存配置
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 7d;
                add_header Cache-Control "public, immutable";
            }
        }

        #-----------------------------------------------------------------------
        # 错误页面
        #-----------------------------------------------------------------------
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root html;
            internal;
        }
    }

    #---------------------------------------------------------------------------
    # HTTPS 服务器配置（可选）
    #---------------------------------------------------------------------------
    # server {
    #     listen 443 ssl http2;
    #     listen [::]:443 ssl http2;
    #     server_name _;
    #
    #     # SSL 证书配置
    #     ssl_certificate /path/to/cert.pem;
    #     ssl_certificate_key /path/to/key.pem;
    #
    #     # SSL 优化配置
    #     ssl_session_timeout 1d;
    #     ssl_session_cache shared:SSL:50m;
    #     ssl_session_tickets off;
    #
    #     # 现代 SSL 配置
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    #     ssl_prefer_server_ciphers off;
    #
    #     # HSTS
    #     add_header Strict-Transport-Security "max-age=63072000" always;
    #
    #     # 其他配置与 HTTP 服务器相同...
    # }

    #---------------------------------------------------------------------------
    # 状态监控服务器（内部使用）
    #---------------------------------------------------------------------------
    server {
        listen 127.0.0.1:8888;
        server_name localhost;
        
        # Nginx 状态
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
        
        # 详细指标
        location /detailed_metrics {
            access_log off;
            allow 127.0.0.1;
            deny all;
            
            content_by_lua_block {
                local cjson = require "cjson.safe"
                local metrics = require "ratelimit.metrics"
                local degradation = require "ratelimit.degradation"
                
                local detailed = {
                    summary = metrics.get_summary(),
                    degradation = degradation.get_status(),
                    worker_id = ngx.worker.id(),
                    worker_count = ngx.worker.count(),
                    timestamp = ngx.now()
                }
                
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode(detailed))
            }
        }
    }
}
