# OpenResty Rate Limiter Configuration
# 分布式三层令牌桶限流系统 - 开发环境配置
# 用于本地开发和测试

#===============================================================================
# 全局配置
#===============================================================================

# 开发环境使用单 Worker
worker_processes 1;

# 开发环境使用 debug 级别日志
error_log logs/error.log debug;

pid logs/nginx.pid;

daemon off;  # 前台运行，便于调试

#===============================================================================
# 事件模块配置
#===============================================================================
events {
    worker_connections 1024;
    use epoll;
}

#===============================================================================
# HTTP 模块配置
#===============================================================================
http {
    include mime.types;
    default_type application/octet-stream;

    # 简化日志格式
    log_format main '$remote_addr [$time_local] "$request" $status '
                    'cost=$ratelimit_cost remaining=$ratelimit_remaining';

    access_log logs/access.log main;

    sendfile on;
    keepalive_timeout 65;

    #---------------------------------------------------------------------------
    # Lua 模块路径配置
    #---------------------------------------------------------------------------
    lua_package_path "$prefix/lua/?.lua;$prefix/lua/ratelimit/?.lua;;";
    lua_package_cpath ";;";

    # 开发环境关闭代码缓存，便于热更新
    lua_code_cache off;

    #---------------------------------------------------------------------------
    # 共享内存字典配置
    #---------------------------------------------------------------------------
    lua_shared_dict ratelimit_dict 10m;
    lua_shared_dict connlimit_dict 5m;
    lua_shared_dict config_dict 2m;
    lua_shared_dict metrics_dict 5m;
    lua_shared_dict locks_dict 1m;

    #---------------------------------------------------------------------------
    # Lua 初始化配置
    #---------------------------------------------------------------------------
    init_by_lua_block {
        require "ratelimit.cost"
        require "ratelimit.init"
        ngx.log(ngx.NOTICE, "[ratelimit] Dev mode: modules loaded")
    }

    init_worker_by_lua_block {
        local init = require "ratelimit.init"
        init.init()
        
        local degradation = require "ratelimit.degradation"
        degradation.start_health_timer()
        
        local metrics = require "ratelimit.metrics"
        metrics.start_report_timer()
        
        ngx.log(ngx.NOTICE, "[ratelimit] Dev worker initialized")
    }

    #---------------------------------------------------------------------------
    # 模拟后端服务
    #---------------------------------------------------------------------------
    server {
        listen 8080;
        server_name localhost;
        
        location / {
            content_by_lua_block {
                local cjson = require "cjson.safe"
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode({
                    message = "Hello from mock backend",
                    method = ngx.req.get_method(),
                    uri = ngx.var.uri,
                    timestamp = ngx.now()
                }))
            }
        }
    }

    #---------------------------------------------------------------------------
    # 主服务器配置
    #---------------------------------------------------------------------------
    server {
        listen 80;
        server_name localhost;

        set $ratelimit_cost 0;
        set $ratelimit_remaining 0;

        # 健康检查
        location = /health {
            access_log off;
            content_by_lua_block {
                local cjson = require "cjson.safe"
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode({
                    status = "healthy",
                    mode = "development",
                    timestamp = ngx.now()
                }))
            }
        }

        # Prometheus 指标
        location = /metrics {
            access_log off;
            content_by_lua_block {
                local metrics = require "ratelimit.metrics"
                metrics.serve_prometheus()
            }
        }

        # 管理 API
        location /admin/ {
            content_by_lua_block {
                local config_api = require "ratelimit.config_api"
                config_api.handle_request()
            }
        }

        # 测试端点：直接返回 Cost 计算结果
        location /test/cost {
            content_by_lua_block {
                local cost_calculator = require "ratelimit.cost"
                local cjson = require "cjson.safe"
                
                local method = ngx.req.get_method()
                local body_size = tonumber(ngx.var.content_length) or 0
                local cost, details = cost_calculator.calculate(method, body_size)
                
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode({
                    cost = cost,
                    details = details
                }))
            }
        }

        # 测试端点：查看限流状态
        location /test/status {
            content_by_lua_block {
                local cjson = require "cjson.safe"
                local shared = ngx.shared.ratelimit_dict
                local degradation = require "ratelimit.degradation"
                local emergency = require "ratelimit.emergency"
                
                local status = {
                    degradation = degradation.get_status(),
                    emergency = emergency.get_status(),
                    stats = {
                        requests_total = shared:get("stats:requests:total") or 0,
                        rejected_total = shared:get("stats:rejected:total") or 0
                    }
                }
                
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode(status))
            }
        }

        # 主业务路由（带限流）
        location / {
            access_by_lua_block {
                local init = require "ratelimit.init"
                local app_id = ngx.var.http_x_app_id or "test-app"
                local cluster_id = ngx.var.http_x_cluster_id or "test-cluster"
                
                local ok, err = init.check(app_id, nil, cluster_id)
                if not ok then
                    return
                end
                
                local ctx = ngx.ctx.ratelimit
                if ctx then
                    ngx.var.ratelimit_cost = ctx.cost or 0
                    ngx.var.ratelimit_remaining = ctx.remaining or 0
                end
            }

            # 开发环境直接返回模拟响应
            content_by_lua_block {
                local cjson = require "cjson.safe"
                local ctx = ngx.ctx.ratelimit or {}
                
                ngx.header["Content-Type"] = "application/json"
                ngx.say(cjson.encode({
                    message = "Request processed",
                    method = ngx.req.get_method(),
                    uri = ngx.var.uri,
                    ratelimit = {
                        cost = ctx.cost,
                        remaining = ctx.remaining,
                        source = ctx.source
                    },
                    timestamp = ngx.now()
                }))
            }

            log_by_lua_block {
                local init = require "ratelimit.init"
                init.log()
            }
        }
    }
}
